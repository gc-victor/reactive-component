function V({updateComputed:d,notifyEffect:e}){let i,n;return{link(t,s){let r=s.depsTail;if(r!==void 0&&r.dep===t)return;let f=r!==void 0?r.nextDep:s.deps;if(f!==void 0&&f.dep===t){s.depsTail=f;return}let o=t.subsTail;if(!(o!==void 0&&o.sub===s&&l(o,s)))return a(t,s,f,r)},propagate(t){let s=32,r=t,f=0;e:do{let o=t.sub,c=o.flags;if(!(c&244)&&(o.flags=c|s|8,!0)||c&16&&!(c&4)&&(o.flags=c&-17|s|8,!0)||!(c&224)&&l(t,o)&&(o.flags=c|16|s|8,o.subs!==void 0)){let g=o.subs;if(g!==void 0){g.nextSub!==void 0?(g.prevSub=r,t=r=g,s=64,++f):(t=g,s=c&2?128:64);continue}c&2&&(n!==void 0?n.depsTail.nextDep=o.deps:i=o,n=o)}else c&(4|s)?!(c&s)&&c&224&&l(t,o)&&(o.flags=c|s):(o.flags=c|s|8,(c&10)===2&&(n!==void 0?n.depsTail.nextDep=o.deps:i=o,n=o));if((t=r.nextSub)!==void 0){r=t,s=f?64:32;continue}for(;f;){--f;let w=r.dep.subs;if(r=w.prevSub,w.prevSub=void 0,(t=r.nextSub)!==void 0){r=t,s=f?64:32;continue e}}break}while(!0)},startTracking(t){t.depsTail=void 0,t.flags=t.flags&-249|4},endTracking(t){let s=t.depsTail;if(s!==void 0){let r=s.nextDep;r!==void 0&&(v(r),s.nextDep=void 0)}else t.deps!==void 0&&(v(t.deps),t.deps=void 0);t.flags&=-5},updateDirtyFlag(t,s){return p(t.deps)?(t.flags=s|32,!0):(t.flags=s&-65,!1)},processComputedUpdate(t,s){if((s&32||(p(t.deps)||(t.flags=s&-65,!1)))&&d(t)){let r=t.subs;r!==void 0&&u(r)}},processPendingInnerEffects(t,s){if(s&128){t.flags=s&-129;let r=t.deps;do{let f=r.dep;"flags"in f&&f.flags&2&&f.flags&224&&e(f),r=r.nextDep}while(r!==void 0)}},processEffectNotifications(){for(;i!==void 0;){let t=i,s=t.depsTail,r=s.nextDep;r!==void 0?(s.nextDep=void 0,i=r.sub):(i=void 0,n=void 0),e(t)||(t.flags&=-9)}}};function a(t,s,r,f){let o={dep:t,sub:s,nextDep:r,prevSub:void 0,nextSub:void 0};if(f===void 0?s.deps=o:f.nextDep=o,t.subs===void 0)t.subs=o;else{let c=t.subsTail;o.prevSub=c,c.nextSub=o}return s.depsTail=o,t.subsTail=o,o}function p(t){let s=0,r;e:do{r=!1;let f=t.dep;if("flags"in f){let o=f.flags;if((o&33)===33){if(d(f)){let c=f.subs;c.nextSub!==void 0&&u(c),r=!0}}else if((o&65)===65){let c=f.subs;c.nextSub!==void 0&&(c.prevSub=t),t=f.deps,++s;continue}}if(!r&&t.nextDep!==void 0){t=t.nextDep;continue}if(s){let o=t.sub;do{--s;let c=o.subs;if(r){if(d(o)){(t=c.prevSub)!==void 0?(c.prevSub=void 0,u(o.subs),o=t.sub):o=c.sub;continue}}else o.flags&=-65;if((t=c.prevSub)!==void 0){if(c.prevSub=void 0,t.nextDep!==void 0){t=t.nextDep;continue e}o=t.sub}else{if((t=c.nextDep)!==void 0)continue e;o=c.sub}r=!1}while(s)}return r}while(!0)}function u(t){do{let s=t.sub,r=s.flags;(r&96)===64&&(s.flags=r|32|8,(r&10)===2&&(n!==void 0?n.depsTail.nextDep=s.deps:i=s,n=s)),t=t.nextSub}while(t!==void 0)}function l(t,s){let r=s.depsTail;if(r!==void 0){let f=s.deps;do{if(f===t)return!0;if(f===r)break;f=f.nextDep}while(f!==void 0)}return!1}function v(t){do{let s=t.dep,r=t.nextDep,f=t.nextSub,o=t.prevSub;if(f!==void 0?f.prevSub=o:s.subsTail=o,o!==void 0?o.nextSub=f:s.subs=f,s.subs===void 0&&"deps"in s){let c=s.flags;c&32||(s.flags=c|32);let g=s.deps;if(g!==void 0){t=g,s.depsTail.nextDep=r,s.deps=void 0,s.depsTail=void 0;continue}}t=r}while(t!==void 0)}}var{link:b,propagate:D,updateDirtyFlag:A,startTracking:E,endTracking:S,processEffectNotifications:C,processComputedUpdate:N,processPendingInnerEffects:x}=V({updateComputed(d){let e=h;h=d,E(d);try{let i=d.currentValue,n=d.getter(i);return i!==n?(d.currentValue=n,!0):!1}finally{h=e,S(d)}},notifyEffect(d){return"isScope"in d?B(d):R(d)}});var P=0,h,T;function L(d){return O.bind({currentValue:d,subs:void 0,subsTail:void 0})}function M(d){return I.bind({currentValue:void 0,subs:void 0,subsTail:void 0,deps:void 0,depsTail:void 0,flags:33,getter:d})}function m(d){let e={fn:d,subs:void 0,subsTail:void 0,deps:void 0,depsTail:void 0,flags:2};return h!==void 0?b(e,h):T!==void 0&&b(e,T),H(e),$.bind(e)}function H(d){let e=h;h=d,E(d);try{d.fn()}finally{h=e,S(d)}}function R(d){let e=d.flags;return e&32||e&64&&A(d,e)?H(d):x(d,d.flags),!0}function B(d){return d.flags&128?(x(d,d.flags),!0):!1}function I(){let d=this.flags;return d&96&&N(this,d),h!==void 0?b(this,h):T!==void 0&&b(this,T),this.currentValue}function O(...d){if(d.length){if(this.currentValue!==(this.currentValue=d[0])){let e=this.subs;e!==void 0&&(D(e),P||C())}}else return h!==void 0&&b(this,h),this.currentValue}function $(){E(this),S(this)}var y=class extends HTMLElement{state=new Map;derived=new Map;bindings=new Map;observers=new Map;stateElements=new Map;refs={};constructor(){super(),this.processElement=this.processElement.bind(this),this.handleStateChange=this.handleStateChange.bind(this)}connectedCallback(){this.processChildren(this),this.setupMutationObserver()}disconnectedCallback(){for(let e of this.observers.values())e.disconnect();this.observers.clear()}setState(e,i){let n=this.coerceValue(i);if(!this.state.has(e))this.state.set(e,L(n)),this.defineStateProperty(e);else{let a=this.state.get(e);a&&a()!==n&&(a(n),this.handleStateChange(e))}}getState(e){return this.state.get(e)?.()??this.derived.get(e)?.()??null}defineStateProperty(e){Object.defineProperty(this,e,{get:()=>this.getState(e),set:i=>this.setState(e,i),configurable:!0,enumerable:!0})}compute(e,i,n){this.derived.has(e)&&console.warn(`Computed property "${e}" is being redefined`);let a=M(()=>{let p=i.map(l=>this.getState(l)),u=n(...p);return this.coerceValue(u)});this.derived.set(e,a),this.effect(()=>{this.handleStateChange(e)})}effect(e){return m(e)}processChildren(e){let i=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:a=>!(a instanceof HTMLElement)||a.tagName.includes("-")&&a!==this?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}),n=i.nextNode();for(;n;)this.processElement(n),n=i.nextNode()}processElement(e){for(let i of Array.from(e.attributes)){let{name:n,value:a}=i;if(!/^[a-zA-Z0-9]+$/.test(a))throw new Error(`Invalid binding value "${a}": must only contain alphanumeric characters`);if(n==="$ref"){if(!a)throw new Error("Ref attribute requires a value");this.refs[a]=e,e.removeAttribute(n)}else if(n==="$state"){let u=a;if(!u)throw new Error("State binding requires a key");this.stateElements.set(u,e);let l=e.hasAttribute("$bind-html"),v=this.coerceValue(l?e.innerHTML:e.textContent);this.setState(u,v),this.addBinding(u,e,"state"),e.removeAttribute(n)}else if(n.startsWith("$bind-")){let u=n.replace("$bind-","");if(!u||!a)throw new Error("Binding requires both type and state key");let l=a;this.addBinding(l,e,u),e.removeAttribute(n)}else if(n.startsWith("on")){let u=n.slice(2);if(!u||!a)throw new Error("Event binding requires event name and handler");let l=a,v=this[l];if(typeof v!="function")throw new Error(`Handler method "${l}" not found or not a function`);let t=s=>{v.call(this,s)};e.addEventListener(u,t),e.removeAttribute(n)}}}coerceValue(e){if(e!=null){if(e==="")return e;if(e==="false"||e==="true")return e==="true";if(typeof e=="string"){let i=Number(e);if(!Number.isNaN(i))return i;try{let n=JSON.parse(e);if(Array.isArray(n)||typeof n=="object")return n}catch{return e}}return e}}addBinding(e,i,n){this.bindings.has(e)||this.bindings.set(e,new Set);let a=this.bindings.get(e);if(a&&a.add({element:i,type:n}),(i instanceof HTMLInputElement||i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement)&&(n==="value"||n==="checked")){let p=()=>{let u=i.value;if(i instanceof HTMLInputElement)switch(i.type){case"checkbox":u=i.checked;break;case"radio":if(u=i.value,i.checked){let l=Array.from(document.querySelectorAll(`input[type="radio"][name="${i.name}"]`));for(let v of l)v instanceof HTMLInputElement&&(v.checked=v===i)}break;case"number":case"range":u=i.valueAsNumber;break;case"date":case"datetime-local":case"time":u=i.valueAsDate;break;case"file":u=i.files;break;default:u=i.value}else i instanceof HTMLSelectElement?i.multiple?u=Array.from(i.selectedOptions).map(l=>l.value):u=i.value:i instanceof HTMLTextAreaElement&&(u=i.value);this.setState(e,u)};i.addEventListener("input",p),(i instanceof HTMLSelectElement||i instanceof HTMLInputElement&&["checkbox","radio","file","date","datetime-local","time","month","week"].includes(i.type))&&i.addEventListener("change",p),i instanceof HTMLInputElement&&["email","url","tel","number"].includes(i.type)&&i.addEventListener("blur",p)}this.updateBinding(e,i,n,this.getState(e))}formatValue(e){return e==null?"":typeof e=="object"?JSON.stringify(e):String(e)}updateBinding(e,i,n,a){let p=this.formatValue(a),u={state:()=>{this.stateElements.has(e)&&(i.textContent=p)},value:()=>{"value"in i&&(i.value=p)},text:()=>{i.textContent=p},html:()=>{i.innerHTML=p},checked:()=>{"checked"in i&&(i.checked=!!a)},disabled:()=>{"disabled"in i&&(i.disabled=!!a)},class:()=>{if(!(!a||typeof a!="object")){for(let[t,s]of Object.entries(a))t==="add"||t==="remove"?Array.isArray(s)?i.classList[t](...s):i.classList[t](s):t==="replace"&&Array.isArray(s)&&s.length===2?i.classList.replace(s[0],s[1]):t==="toggle"&&(typeof s=="string"?i.classList.toggle(s):typeof s=="object"&&i.classList.toggle(s.key,s.value));i.classList.length===0&&i.removeAttribute("class")}},attr:()=>{if(typeof a=="string")i.removeAttribute(a);else if(typeof a=="object"&&a!==null)for(let[t,s]of Object.entries(a))s===null||s===!1?i.removeAttribute(t):i.setAttribute(t,String(s))}},l=this.customBindingHandlers({stateKey:e,element:i,formattedValue:p,rawValue:a});({...u,...l})[n]?.()}customBindingHandlers({stateKey:e,element:i,formattedValue:n,rawValue:a}){return{}}handleStateChange(e){let i=this.getState(e),n=this.bindings.get(e);if(n)for(let{element:a,type:p}of n)this.updateBinding(e,a,p,i)}setupMutationObserver(){let e=new MutationObserver(i=>{for(let n of i)for(let a of Array.from(n.addedNodes))a instanceof HTMLElement&&this.processChildren(a)});e.observe(this,{childList:!0,subtree:!0}),this.observers.set(this,e)}};typeof window<"u"&&(window.ReactiveComponent=y);export{y as ReactiveComponent};
