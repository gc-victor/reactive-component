var H;(function(n){n[n.None=0]="None",n[n.Mutable=1]="Mutable",n[n.Watching=2]="Watching",n[n.RecursedCheck=4]="RecursedCheck",n[n.Recursed=8]="Recursed",n[n.Dirty=16]="Dirty",n[n.Pending=32]="Pending"})(H||(H={}));function A({update:n,notify:e,unwatched:t}){return{link:i,unlink:s,propagate:c,checkDirty:g,endTracking:p,startTracking:u,shallowPropagate:v};function i(r,o){let d=o.depsTail;if(d!==void 0&&d.dep===r)return;let a,f=o.flags&4;if(f&&(a=d!==void 0?d.nextDep:o.deps,a!==void 0&&a.dep===r)){o.depsTail=a;return}let h=r.subsTail;if(h!==void 0&&h.sub===o&&(!f||l(h,o)))return;let b=o.depsTail=r.subsTail={dep:r,sub:o,prevDep:d,nextDep:a,prevSub:h,nextSub:void 0};a!==void 0&&(a.prevDep=b),d!==void 0?d.nextDep=b:o.deps=b,h!==void 0?h.nextSub=b:r.subs=b}function s(r,o=r.sub){let d=r.dep,a=r.prevDep,f=r.nextDep,h=r.nextSub,b=r.prevSub;return f!==void 0?f.prevDep=a:o.depsTail=a,a!==void 0?a.nextDep=f:o.deps=f,h!==void 0?h.prevSub=b:d.subsTail=b,b!==void 0?b.nextSub=h:(d.subs=h)===void 0&&t(d),f}function c(r){let o=r.nextSub,d;e:do{let a=r.sub,f=a.flags;if(f&3&&(f&60?f&12?f&4?!(f&48)&&l(r,a)?(a.flags=f|40,f&=1):f=0:a.flags=f&-9|32:f=0:a.flags=f|32,f&2&&e(a),f&1)){let h=a.subs;if(h!==void 0){r=h,h.nextSub!==void 0&&(d={value:o,prev:d},o=r.nextSub);continue}}if((r=o)!==void 0){o=r.nextSub;continue}for(;d!==void 0;)if(r=d.value,d=d.prev,r!==void 0){o=r.nextSub;continue e}break}while(!0)}function u(r){r.depsTail=void 0,r.flags=r.flags&-57|4}function p(r){let o=r.depsTail,d=o!==void 0?o.nextDep:r.deps;for(;d!==void 0;)d=s(d,r);r.flags&=-5}function g(r,o){let d,a=0;e:do{let f=r.dep,h=f.flags,b=!1;if(o.flags&16)b=!0;else if((h&17)===17){if(n(f)){let x=f.subs;x.nextSub!==void 0&&v(x),b=!0}}else if((h&33)===33){(r.nextSub!==void 0||r.prevSub!==void 0)&&(d={value:r,prev:d}),r=f.deps,o=f,++a;continue}if(!b&&r.nextDep!==void 0){r=r.nextDep;continue}for(;a;){--a;let x=o.subs,V=x.nextSub!==void 0;if(V?(r=d.value,d=d.prev):r=x,b){if(n(o)){V&&v(x),o=r.sub;continue}}else o.flags&=-33;if(o=r.sub,r.nextDep!==void 0){r=r.nextDep;continue e}b=!1}return b}while(!0)}function v(r){do{let o=r.sub,d=r.nextSub,a=o.flags;(a&48)===32&&(o.flags=a|16,a&2&&e(o)),r=d}while(r!==void 0)}function l(r,o){let d=o.depsTail;if(d!==void 0){let a=o.deps;do{if(a===r)return!0;if(a===d)break;a=a.nextDep}while(a!==void 0)}return!1}}var w=[],{link:m,unlink:C,propagate:U,checkDirty:D,endTracking:N,startTracking:P,shallowPropagate:B}=A({update(n){return"getter"in n?R(n):I(n,n.value)},notify:j,unwatched(n){if("getter"in n){let e=n.deps;if(e!==void 0){n.flags=17;do e=C(e,n);while(e!==void 0)}}else"previousValue"in n||q.call(n)}}),J=0,y=0,L=0,S,E;function T(n){let e=S;return S=n,e}function $(n){return F.bind({previousValue:n,value:n,subs:void 0,subsTail:void 0,flags:1})}function k(n){return z.bind({value:void 0,subs:void 0,subsTail:void 0,deps:void 0,depsTail:void 0,flags:17,getter:n})}function O(n){let e={fn:n,subs:void 0,subsTail:void 0,deps:void 0,depsTail:void 0,flags:2};S!==void 0?m(e,S):E!==void 0&&m(e,E);let t=T(e);try{e.fn()}finally{T(t)}return q.bind(e)}function R(n){let e=T(n);P(n);try{let t=n.value;return t!==(n.value=n.getter(t))}finally{T(e),N(n)}}function I(n,e){return n.flags=1,n.previousValue!==(n.previousValue=e)}function j(n){let e=n.flags;if(!(e&64)){n.flags=e|64;let t=n.subs;t!==void 0?j(t.sub):w[L++]=n}}function W(n,e){if(e&16||e&32&&D(n.deps,n)){let i=T(n);P(n);try{n.fn()}finally{T(i),N(n)}return}else e&32&&(n.flags=e&-33);let t=n.deps;for(;t!==void 0;){let i=t.dep,s=i.flags;s&64&&W(i,i.flags=s&-65),t=t.nextDep}}function _(){for(;y<L;){let n=w[y];w[y++]=void 0,W(n,n.flags&=-65)}y=0,L=0}function z(){let n=this.flags;if(n&16||n&32&&D(this.deps,this)){if(R(this)){let e=this.subs;e!==void 0&&B(e)}}else n&32&&(this.flags=n&-33);return S!==void 0?m(this,S):E!==void 0&&m(this,E),this.value}function F(...n){if(n.length){let e=n[0];if(this.value!==(this.value=e)){this.flags=17;let t=this.subs;t!==void 0&&(U(t),J||_())}}else{let e=this.value;if(this.flags&16&&I(this,e)){let t=this.subs;t!==void 0&&B(t)}return S!==void 0&&m(this,S),e}}function q(){let n=this.deps;for(;n!==void 0;)n=C(n,this);let e=this.subs;e!==void 0&&C(e),this.flags=0}function K(n){let e=`reactive-component-context-${n}`;return{id:Symbol(e),eventName:e,state:n}}var M=class n extends HTMLElement{state=new Map;exposedContexts=new Set;contextSubscriptions=new Map;derived=new Map;bindings=new Map;observers=new Map;stateElements=new Map;refs={};constructor(){super(),this.processElement=this.processElement.bind(this),this.handleStateChange=this.handleStateChange.bind(this)}connectedCallback(){this.processChildren(this),this.setupMutationObserver()}exposeContext(e){let t=e.state;if(!this.state.has(t)&&!this.derived.has(t)){console.warn(`Cannot expose context "${t}": state or computed value not found`);return}this.exposedContexts.add(e.id),this.effect(()=>{let i=this.getState(t);this.broadcastContextUpdate(e,i)})}broadcastContextUpdate(e,t){let i=e.state,s=new CustomEvent(e.eventName,{bubbles:!0,composed:!0,detail:{key:i,value:t,source:this}});this.dispatchEvent(s)}consumeContext(e){let t=e.state,i=this.findContextProvider(e);if(!i){console.warn(`Context "${t}" not found in any parent component`);return}let s=i.getState(t);this.setState(t,s);let c=this.subscribeToContextUpdates(e,i,u=>{let p=this.state.get(t);p&&(p(u),this.handleStateChange(t))});this.contextSubscriptions.set(t,c)}findContextProvider(e){let t=this.parentElement;for(;t;){if(t instanceof n&&t.exposedContexts&&t.exposedContexts.has(e.id))return t;t=t.parentElement}return null}subscribeToContextUpdates(e,t,i){let s=e.state,c=u=>{let g=u.detail;g.key===s&&g.source===t&&i(g.value)};return t.addEventListener(e.eventName,c),()=>{t.removeEventListener(e.eventName,c)}}disconnectedCallback(){for(let e of this.observers.values())e.disconnect();this.observers.clear();for(let e of this.contextSubscriptions.values())e();this.contextSubscriptions.clear()}setState(e,t){let i=this.coerceValue(t);if(!this.state.has(e))this.state.set(e,$(i)),this.defineStateProperty(e);else{let s=this.state.get(e);s&&s()!==i&&(s(i),this.handleStateChange(e))}}getState(e){return this.state.get(e)?.()??this.derived.get(e)?.()??null}defineStateProperty(e){Object.defineProperty(this,e,{get:()=>this.getState(e),set:t=>this.setState(e,t),configurable:!0,enumerable:!0})}compute(e,t,i){this.derived.has(e)&&console.warn(`Computed property "${e}" is being redefined`);let s=k(()=>{let c=t.map(p=>this.getState(p)),u=i(...c);return this.coerceValue(u)});this.derived.set(e,s),this.effect(()=>{let c=s();this.updateBindingsForKey(e,c)})}updateBindingsForKey(e,t){let i=this.bindings.get(e);if(i)for(let{element:s,type:c}of i)this.updateBinding(e,s,c,t)}effect(e){return O(e)}processChildren(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:s=>!(s instanceof HTMLElement)||s.tagName.includes("-")&&s!==this?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}),i=t.nextNode();for(;i;)this.processElement(i),i=t.nextNode()}processElement(e){for(let t of Array.from(e.attributes)){let{name:i,value:s}=t;if(!/^[a-zA-Z0-9]+$/.test(s)&&i.startsWith("$"))throw new Error(`Invalid binding ${i} value "${s}": must only contain alphanumeric characters`);if(i==="$ref"){if(!s)throw new Error("Ref attribute requires a value");this.refs[s]=e,e.removeAttribute(i)}else if(i==="$state"){let u=s;if(!u)throw new Error("State binding requires a key");this.stateElements.set(u,e);let p=e.hasAttribute("$bind-html"),g=this.coerceValue(p?e.innerHTML:e.textContent);this.setState(u,g),this.addBinding(u,e,"state"),e.removeAttribute(i)}else if(i.startsWith("$bind-")){let u=i.replace("$bind-","");if(!u||!s)throw new Error("Binding requires both type and state key");let p=s;this.addBinding(p,e,u),e.removeAttribute(i)}else if(i.startsWith("on")){let u=i.slice(2);if(!u||!s)throw new Error("Event binding requires event name and handler");let p=s,g=this[p];if(typeof g!="function")throw new Error(`Handler method "${p}" not found or not a function`);let v=l=>{g.call(this,l)};e.addEventListener(u,v),e.removeAttribute(i)}}}coerceValue(e){if(e!=null){if(e==="")return e;if(e==="false"||e==="true")return e==="true";if(typeof e=="string"){let t=Number(e);if(!Number.isNaN(t))return t;try{let i=JSON.parse(e);if(Array.isArray(i)||typeof i=="object")return i}catch{return e}}return e}}addBinding(e,t,i){this.bindings.has(e)||this.bindings.set(e,new Set);let s=this.bindings.get(e);if(s&&s.add({element:t,type:i}),(t instanceof HTMLInputElement||t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement)&&(i==="value"||i==="checked")){let c=()=>{let u=t.value;if(t instanceof HTMLInputElement)switch(t.type){case"checkbox":u=t.checked;break;case"radio":if(u=t.value,t.checked){let p=Array.from(document.querySelectorAll(`input[type="radio"][name="${t.name}"]`));for(let g of p)g instanceof HTMLInputElement&&(g.checked=g===t)}break;case"number":case"range":u=t.valueAsNumber;break;case"date":case"datetime-local":case"time":u=t.valueAsDate;break;case"file":u=t.files;break;default:u=t.value}else t instanceof HTMLSelectElement?t.multiple?u=Array.from(t.selectedOptions).map(p=>p.value):u=t.value:t instanceof HTMLTextAreaElement&&(u=t.value);this.setState(e,u)};t.addEventListener("input",c),(t instanceof HTMLSelectElement||t instanceof HTMLInputElement&&["checkbox","radio","file","date","datetime-local","time","month","week"].includes(t.type))&&t.addEventListener("change",c),t instanceof HTMLInputElement&&["email","url","tel","number"].includes(t.type)&&t.addEventListener("blur",c)}this.updateBinding(e,t,i,this.getState(e))}formatValue(e){return e==null?"":typeof e=="object"?JSON.stringify(e):String(e)}updateBinding(e,t,i,s){let c=this.formatValue(s),u={state:()=>{this.stateElements.has(e)&&(t.textContent=c)},value:()=>{"value"in t&&(t.value=c)},text:()=>{t.textContent=c},html:()=>{t.innerHTML=c},checked:()=>{"checked"in t&&(t.checked=!!s)},disabled:()=>{"disabled"in t&&(t.disabled=!!s)},class:()=>{if(!(!s||typeof s!="object")){for(let[v,l]of Object.entries(s))v==="add"||v==="remove"?Array.isArray(l)?t.classList[v](...l):t.classList[v](l):v==="replace"&&Array.isArray(l)&&l.length===2?t.classList.replace(l[0],l[1]):v==="toggle"&&(typeof l=="string"?t.classList.toggle(l):typeof l=="object"&&t.classList.toggle(l.key,l.value));t.classList.length===0&&t.removeAttribute("class")}},attr:()=>{if(typeof s=="string")t.removeAttribute(s);else if(typeof s=="object"&&s!==null)for(let[v,l]of Object.entries(s))l===null||l===!1?t.removeAttribute(v):t.setAttribute(v,String(l))}},p=this.customBindingHandlers({stateKey:e,element:t,formattedValue:c,rawValue:s});({...u,...p})[i]?.()}customBindingHandlers({stateKey:e,element:t,formattedValue:i,rawValue:s}){return{}}handleStateChange(e){let t=this.getState(e),i=this.bindings.get(e);if(i)for(let{element:s,type:c}of i)this.updateBinding(e,s,c,t)}setupMutationObserver(){let e=new MutationObserver(t=>{for(let i of t)for(let s of Array.from(i.addedNodes))s instanceof HTMLElement&&this.processChildren(s)});e.observe(this,{childList:!0,subtree:!0}),this.observers.set(this,e)}};typeof window<"u"&&(window.ReactiveComponent=M);export{M as ReactiveComponent,K as createContext};
